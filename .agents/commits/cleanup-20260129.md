# Commit Plan - Cleanup Working Tree

**Date**: 2026-01-29
**Purpose**: Commit all outstanding work from audit remediation and logger migration

---

## Summary

- **Total files**: 705 changed
- **Insertions**: 10,232
- **Deletions**: 270,665
- **Commits planned**: 5

---

## Commit 1: refactor(database): split types into domain modules

**Scope**: Phase 5.1 - Database types refactoring

**Files** (14 files):

- `app/lib/db/types.ts` (now barrel export)
- `app/lib/db/types/*.ts` (13 new domain modules)

**Message**:

```
refactor(database): split types into domain modules

Phase 5.1 completion - split monolithic types.ts (1,672 lines) into 13 domain-specific modules:

- types/auth.ts - User, Session, Account tables
- types/settings.ts - UserSettings table
- types/farms.ts - Farm, FarmModule, UserFarm, Structure tables
- types/livestock.ts - Breed, Batch, Egg, Weight tables
- types/health.ts - Mortality, Vaccination, Treatment, WaterQuality tables
- types/feed.ts - Feed, FeedInventory, MedicationInventory, Formulation tables
- types/financial.ts - Sale, Expense, Customer, Supplier, Invoice tables
- types/monitoring.ts - AuditLog, GrowthStandard, MarketPrice, Notification, Task, Report tables
- types/digital-foreman.ts - Worker, Geofence, CheckIn, TaskAssignment, Payroll tables
- types/sensors.ts - Sensor, SensorReading, SensorAggregate, SensorAlert tables
- types/marketplace.ts - MarketplaceListing, ListingContactRequest, ListingView tables
- types/extension-worker.ts - Country, Region, UserDistrict, AccessRequest, VisitRecord, OutbreakAlert tables

Main types.ts now serves as barrel export (366 lines vs 1,672 lines).
Improves maintainability and reduces cognitive load.
```

---

## Commit 2: refactor(batches): split server functions into subdirectory

**Scope**: Phase 5.4 - Batches server refactoring

**Files** (7 files):

- `app/features/batches/server.ts` (now barrel export, 15 lines)
- `app/features/batches/server/crud.ts` (NEW)
- `app/features/batches/server/queries.ts` (NEW)
- `app/features/batches/server/stats.ts` (NEW)
- `app/features/batches/server/validation.ts` (NEW)
- `app/features/batches/server/types.ts` (NEW)
- `app/features/batches/server/index.ts` (NEW)

**Message**:

```
refactor(batches): split server functions into subdirectory

Phase 5.4 completion - split monolithic server.ts (1,093 lines) into organized subdirectory:

- server/crud.ts - Create, update, delete operations
- server/queries.ts - GET operations and paginated queries
- server/stats.ts - Statistics and summary functions
- server/validation.ts - Zod validation schemas
- server/types.ts - Type definitions and constants
- server/index.ts - Barrel export

Main server.ts now serves as barrel export (15 lines vs 1,093 lines).
Improves code organization and maintainability.
```

---

## Commit 3: feat(security): add middleware and bulk operations

**Scope**: Phase 4 security hardening and performance

**Files** (7 files):

- `app/lib/middleware/rate-limit.ts` (NEW)
- `app/lib/middleware/csrf.ts` (NEW)
- `app/lib/middleware/security-headers.ts` (NEW)
- `app/lib/db/bulk-operations.ts` (NEW)
- `app/features/monitoring/constants.ts` (NEW)
- `app/lib/errors/error-map.ts` (updated with new error codes)

**Message**:

```
feat(security): add middleware and bulk operations

Phase 4 completion - security hardening and performance optimizations:

**Security Middleware**:
- Rate limiting for public routes (/shared/*)
- CSRF protection integrated with Better Auth
- Security headers (CSP, HSTS, X-Frame-Options, etc.)

**Performance**:
- Bulk operations (bulkInsert, bulkUpdate) for batch processing
- Species-specific mortality thresholds (6 livestock types)

**Error Handling**:
- Added error codes: RATE_LIMITED, CSRF_TOKEN_MISSING, CSRF_TOKEN_INVALID

All middleware is Cloudflare Workers compatible.
```

---

## Commit 4: refactor(logging): migrate to structured logger

**Scope**: Logger migration - Phase 4.15 completion

**Files** (19 files):

- `app/lib/logger.ts` (enhanced implementation)
- `app/routes/login.tsx`
- `app/lib/logging/audit.ts`
- `app/lib/use-deduplicated-sync.ts`
- `app/components/dialogs/*.tsx` (7 files)
- `app/components/batches/*.tsx` (3 files)
- `app/components/layout/fab.tsx`
- `app/components/feed-formulation/saved-formulations.tsx`
- `app/components/modules/selector.tsx`
- `app/components/onboarding/complete-step.tsx`

**Message**:

```
refactor(logging): migrate to structured logger

Completed Phase 4.15 - migrate console.* calls to structured logger:

**Logger Implementation**:
- Fixed cloudflare:workers import issue (broke dev server)
- Environment-aware logging (dev vs production)
- Structured format: [DEBUG], [INFO], [ERROR] prefixes
- Production-safe (filters sensitive error details)

**Migration**:
- Migrated 15 files (~30 console statements)
- Replaced console.log() → logger.debug()
- Replaced console.error() → logger.error()
- All application code now uses structured logging

**Preserved**:
- CLI tools (migrate.ts, test-connection.ts) - intentional console output
- SMS console provider - intentional console-based provider
- JSDoc comments - documentation examples

Components and routes are now 100% console-free.
```

---

## Commit 5: chore(types): fix TypeScript and lint errors

**Scope**: Phase 4 type safety improvements and validation fixes

**Files** (~100 files):

- `app/features/*/validation.ts` (Zod enhancements)
- `app/features/*/repository.ts` (Kysely type fixes)
- `app/features/*/server.ts` (type safety improvements)
- `app/components/*.tsx` (array type standardization)
- `app/lib/i18n/locales/*.ts` (type fixes)
- `tests/features/*/*.test.ts` (test updates)

**Message**:

```
chore(types): fix TypeScript and lint errors

Phase 4 completion - type safety and code quality improvements:

**Type Safety**:
- Fixed 93 TypeScript errors (152 → 59, 61% reduction)
- Standardized array types to Array<T> syntax
- Fixed Kysely query builder types in repositories
- Enhanced Zod validation schemas

**Validation**:
- Species cross-validation (livestock type ↔ species)
- Age-appropriate weight validation
- Feed type compatibility matrix (25+ feed types)

**Code Quality**:
- Fixed ESLint errors (array-type, no-unnecessary-condition)
- Removed unused imports and variables
- Standardized error handling patterns

**Tests**:
- Updated test expectations for new validation
- Fixed property test generators
```

---

## Commit 6: chore(ui): add reusable components from Phase 3

**Scope**: Phase 3 code duplication elimination

**Files** (~30 files):

- `app/components/ui/data-table-skeleton.tsx` (NEW)
- `app/components/ui/delete-confirm-dialog.tsx` (NEW)
- `app/components/ui/action-column.tsx` (NEW)
- `app/components/ui/summary-card.tsx` (NEW)
- `app/components/ui/detail-skeleton.tsx` (NEW)
- `app/components/ui/filters/*.tsx` (NEW - 3 files)
- `app/components/ui/loading/*.tsx` (NEW - 3 files)
- `app/components/settings/users/*.tsx` (NEW - 8 files)
- `app/hooks/use-form-dialog.ts` (NEW)
- `app/lib/validation/search-params.ts` (NEW)

**Message**:

```
chore(ui): add reusable components from Phase 3

Phase 3 completion - code duplication elimination:

**Generic Components** (15 new):
- DataTableSkeleton - replaces 26 files (~800 lines saved)
- DeleteConfirmDialog - replaces 6 files (~300 lines saved)
- ActionColumn - replaces 12 columns (~72 lines saved)
- SummaryCard - replaces 7 implementations (~385 lines saved)
- DetailSkeleton - replaces 3 skeletons (~150 lines saved)
- Filter components (date-range, status, search)
- Loading states (spinner, overlay, button)

**Hooks & Utilities**:
- useFormDialog - replaces 15+ patterns (~225 lines saved)
- createSearchValidator - replaces 12+ functions (~200 lines saved)

**User Management**:
- Split users route into 8 components (200 lines vs 947 lines)

Total: 2,732+ lines eliminated (5,318+ potential when fully adopted)
```

---

## Commit 7: chore(docs): update generated documentation

**Scope**: Auto-generated TypeDoc documentation

**Files** (~600 files):

- `public/typedocs/**/*` (all generated docs)
- `docs/**/*.md` (documentation updates)
- `DEVLOG.md` (development log)
- `README.md` (readme updates)

**Message**:

```
chore(docs): update generated documentation

Updated TypeDoc documentation and project docs:

- Regenerated API documentation for all modules
- Updated DEVLOG with recent progress
- Updated README with current status
- Refreshed i18n documentation

Auto-generated from codebase changes.
```

---

## Execution Commands

```bash
# Commit 1: Database types refactoring
git add app/lib/db/types.ts app/lib/db/types/
git commit -m "refactor(database): split types into domain modules

Phase 5.1 completion - split monolithic types.ts (1,672 lines) into 13 domain-specific modules:

- types/auth.ts - User, Session, Account tables
- types/settings.ts - UserSettings table
- types/farms.ts - Farm, FarmModule, UserFarm, Structure tables
- types/livestock.ts - Breed, Batch, Egg, Weight tables
- types/health.ts - Mortality, Vaccination, Treatment, WaterQuality tables
- types/feed.ts - Feed, FeedInventory, MedicationInventory, Formulation tables
- types/financial.ts - Sale, Expense, Customer, Supplier, Invoice tables
- types/monitoring.ts - AuditLog, GrowthStandard, MarketPrice, Notification, Task, Report tables
- types/digital-foreman.ts - Worker, Geofence, CheckIn, TaskAssignment, Payroll tables
- types/sensors.ts - Sensor, SensorReading, SensorAggregate, SensorAlert tables
- types/marketplace.ts - MarketplaceListing, ListingContactRequest, ListingView tables
- types/extension-worker.ts - Country, Region, UserDistrict, AccessRequest, VisitRecord, OutbreakAlert tables

Main types.ts now serves as barrel export (366 lines vs 1,672 lines).
Improves maintainability and reduces cognitive load."

# Commit 2: Batches server refactoring
git add app/features/batches/server.ts app/features/batches/server/
git commit -m "refactor(batches): split server functions into subdirectory

Phase 5.4 completion - split monolithic server.ts (1,093 lines) into organized subdirectory:

- server/crud.ts - Create, update, delete operations
- server/queries.ts - GET operations and paginated queries
- server/stats.ts - Statistics and summary functions
- server/validation.ts - Zod validation schemas
- server/types.ts - Type definitions and constants
- server/index.ts - Barrel export

Main server.ts now serves as barrel export (15 lines vs 1,093 lines).
Improves code organization and maintainability."

# Commit 3: Security middleware
git add app/lib/middleware/ app/lib/db/bulk-operations.ts app/features/monitoring/constants.ts app/lib/errors/error-map.ts
git commit -m "feat(security): add middleware and bulk operations

Phase 4 completion - security hardening and performance optimizations:

**Security Middleware**:
- Rate limiting for public routes (/shared/*)
- CSRF protection integrated with Better Auth
- Security headers (CSP, HSTS, X-Frame-Options, etc.)

**Performance**:
- Bulk operations (bulkInsert, bulkUpdate) for batch processing
- Species-specific mortality thresholds (6 livestock types)

**Error Handling**:
- Added error codes: RATE_LIMITED, CSRF_TOKEN_MISSING, CSRF_TOKEN_INVALID

All middleware is Cloudflare Workers compatible."

# Commit 4: Logger migration
git add app/lib/logger.ts app/routes/login.tsx app/lib/logging/audit.ts app/lib/use-deduplicated-sync.ts app/components/dialogs/ app/components/batches/batch-edit-dialog.tsx app/components/batches/batch-filters.tsx app/components/batches/command-center.tsx app/components/layout/fab.tsx app/components/feed-formulation/saved-formulations.tsx app/components/modules/selector.tsx app/components/onboarding/complete-step.tsx
git commit -m "refactor(logging): migrate to structured logger

Completed Phase 4.15 - migrate console.* calls to structured logger:

**Logger Implementation**:
- Fixed cloudflare:workers import issue (broke dev server)
- Environment-aware logging (dev vs production)
- Structured format: [DEBUG], [INFO], [ERROR] prefixes
- Production-safe (filters sensitive error details)

**Migration**:
- Migrated 15 files (~30 console statements)
- Replaced console.log() → logger.debug()
- Replaced console.error() → logger.error()
- All application code now uses structured logging

**Preserved**:
- CLI tools (migrate.ts, test-connection.ts) - intentional console output
- SMS console provider - intentional console-based provider
- JSDoc comments - documentation examples

Components and routes are now 100% console-free."

# Commit 5: Type fixes
git add app/features/ app/components/ app/lib/i18n/ tests/
git commit -m "chore(types): fix TypeScript and lint errors

Phase 4 completion - type safety and code quality improvements:

**Type Safety**:
- Fixed 93 TypeScript errors (152 → 59, 61% reduction)
- Standardized array types to Array<T> syntax
- Fixed Kysely query builder types in repositories
- Enhanced Zod validation schemas

**Validation**:
- Species cross-validation (livestock type ↔ species)
- Age-appropriate weight validation
- Feed type compatibility matrix (25+ feed types)

**Code Quality**:
- Fixed ESLint errors (array-type, no-unnecessary-condition)
- Removed unused imports and variables
- Standardized error handling patterns

**Tests**:
- Updated test expectations for new validation
- Fixed property test generators"

# Commit 6: Reusable components
git add app/components/ui/ app/components/settings/users/ app/hooks/use-form-dialog.ts app/lib/validation/search-params.ts
git commit -m "chore(ui): add reusable components from Phase 3

Phase 3 completion - code duplication elimination:

**Generic Components** (15 new):
- DataTableSkeleton - replaces 26 files (~800 lines saved)
- DeleteConfirmDialog - replaces 6 files (~300 lines saved)
- ActionColumn - replaces 12 columns (~72 lines saved)
- SummaryCard - replaces 7 implementations (~385 lines saved)
- DetailSkeleton - replaces 3 skeletons (~150 lines saved)
- Filter components (date-range, status, search)
- Loading states (spinner, overlay, button)

**Hooks & Utilities**:
- useFormDialog - replaces 15+ patterns (~225 lines saved)
- createSearchValidator - replaces 12+ functions (~200 lines saved)

**User Management**:
- Split users route into 8 components (200 lines vs 947 lines)

Total: 2,732+ lines eliminated (5,318+ potential when fully adopted)"

# Commit 7: Documentation
git add public/typedocs/ docs/ DEVLOG.md README.md .agents/
git commit -m "chore(docs): update generated documentation

Updated TypeDoc documentation and project docs:

- Regenerated API documentation for all modules
- Updated DEVLOG with recent progress
- Updated README with current status
- Refreshed i18n documentation

Auto-generated from codebase changes."
```

---

## Validation

After all commits:

```bash
# Verify clean working tree
git status  # Should show: "nothing to commit, working tree clean"

# Verify commits
git log --oneline -7

# Run validation
bun run check && bun run test --run
```

---

## Summary

**7 commits** covering:

1. Database types refactoring (Phase 5.1)
2. Batches server refactoring (Phase 5.4)
3. Security middleware (Phase 4)
4. Logger migration (Phase 4.15)
5. Type safety improvements (Phase 4)
6. Reusable components (Phase 3)
7. Documentation updates

**Result**: Clean working tree, ready for next work session
